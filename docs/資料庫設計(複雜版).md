# 資料庫設計 — Ansible 自動化網站部署管理系統

本節先用白話介紹名詞、各資料表的職責與彼此關係，作為閱讀全檔的快速導覽與共同語意基準。

名詞解釋與職責/關係總覽（與 API/專案說明一致）
- User（users）：平台使用者帳號，包含角色 Admin/Developer。許多物件的 created_by 或 initiated_by 指向 user，方便審計；部署工作（Job）由使用者發起。
- SSH Key（ssh_keys）：主機連線所需的金鑰憑證與指紋。Host 可參考一把 SSH Key（hosts.ssh_key_id）。若被 Host 參照，刪除應回 409。
- Host（hosts）：被部署的目標主機，含 name/hostname/port/username 與主機層級變數 vars。Host 可加入多個 Group（經由 host_group_members）。
- Group（groups + host_group_members）：Inventory 群組，聚合一批 Host，並有群組層級變數 vars，會套用到該群組所有成員。Host 與 Group 是多對多關係。
- Inventory（概念）：Ansible 執行時的目標清單與變數集合，來源是資料庫中的 Hosts/Groups 以及選取的 target_host_ids。執行時會動態產生暫時性 inventory 檔案供 Ansible 使用。
- Playbook（playbooks）：以 content_struct（結構化 JSON）儲存的可執行流程定義，描述變數（vars）與任務（tasks）。raw_yaml 為可選只讀導出；部署時必須選擇已儲存的 playbook_id（不接受 inline 上傳）。
- Task（playbook.tasks，屬於 Playbook 的內容結構）：單一步驟的作業定義，對應 Ansible 模組（module + params），按順序執行。
- Vars（playbook.vars）：Playbook 定義的參數清單（名稱、型別、預設值、是否必填），供前端產生表單；執行時與 Job 的 extra_vars 合併使用。
- Extra Vars（deploy_jobs.extra_vars）：Job 層級的輸入參數，覆寫或補充 Playbook 預設值。平台層合併邏輯為「playbook.vars 預設」+「job.extra_vars」；實際 Ansible 仍有更完整優先序，本文只涉及平台提供的兩層。
- Job（deploy_jobs）：一次部署執行請求，記錄使用的 playbook_id、initiated_by、status、run_mode、extra_vars 與時間戳記。建立後由背景程序執行。
- Job Target（deploy_job_targets）：Job 在每一台目標主機上的執行結果（status/changed/elapsed_ms 等），用來呈現 per-host 成敗與耗時。
- Job Logs（deploy_job_logs）：行為單位日誌，保存即時輸出與時間點；WebSocket 即時日誌會以此為資料來源之一，Audit 也可用此表回溯完整執行。
- Realtime Logs（WebSocket，概念）：非資料表；伺服器於 Job 執行期間推送 status/log 事件給前端，用於即時顯示。
- Audit/History（概念）：以 deploy_jobs、deploy_job_targets、deploy_job_logs 的查詢/聚合為基礎，提供列表、詳細與日誌下載。

---

本文為後端與前端共同依據的資料庫設計說明，與《API 設計》《專案說明書》一致（AI 助理為未來擴充，核心資料設計不依賴 AI）。

設計原則（MySQL 8.0+）
- 採用 MySQL 8.0+，主鍵以 UUID（CHAR(36)）為主；時間使用 DATETIME(6)（UTC）。
- 重要物件皆有 created_at/updated_at（如適用），利於審計與除錯；updated_at 採 ON UPDATE CURRENT_TIMESTAMP(6)。
- 可序列化欄位（vars、content_struct、extra_vars、logs）採用 JSON 型別（如需預設空物件，可用 DEFAULT (JSON_OBJECT())，需 MySQL 8.0.13+）。
- 關聯關係與刪除策略明確：避免意外連鎖刪除；需回 409 的情境由應用程式層面先檢查並阻擋。

不變契約（與 API 一致）
- Playbook 以 content_struct（結構化 JSON）儲存，前端以表單編輯；部署時必須選擇已儲存的 playbook_id。不接受於建立部署工作時上傳臨時 content_struct（inline）。
- 即時日誌透過 WebSocket 串流；完整日誌可文字或 JSON 行陣列查詢。

---

## 實體與關聯（ER 摘要）

- users 1—* ssh_keys（created_by）
- users 1—* groups（created_by）
- users 1—* playbooks（created_by）
- users 1—* deploy_jobs（initiated_by）
- ssh_keys 1—* hosts（hosts.ssh_key_id）
- hosts *—* groups（經由 host_group_members）
- playbooks 1—* deploy_jobs
- deploy_jobs 1—* deploy_job_targets
- deploy_jobs 1—* deploy_job_logs

註：AI 模組若啟用，ai_tasks 將與 users、playbooks、deploy_jobs 形成關聯（本文置於附錄，非 MVP）。

---

## 資料表定義

以下型別以 MySQL 8.0+ 表示；若採其他版本/資料庫，請依實際支援度調整。

### 1) users
- 目的：登入與權限。
- 角色：Admin | Developer。

欄位
- id UUID PK
- username TEXT unique not null
- email TEXT null
- password_hash TEXT not null
- role TEXT not null check (role in ('Admin','Developer'))
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()

索引/約束
- unique (username)

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `users` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `username` VARCHAR(255) NOT NULL COMMENT '登入帳號（唯一）',
  `email` VARCHAR(255) NULL COMMENT '電子郵件',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '密碼雜湊值',
  `role` ENUM('Admin','Developer') NOT NULL COMMENT '角色：Admin/Developer',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  `updated_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '更新時間(UTC)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_users_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='使用者';
```

### 2) ssh_keys
- 目的：SSH 公鑰管理（API 支援建立與查詢；刪除時若被 hosts 參考應回 409）。

欄位
- id UUID PK
- name TEXT unique not null
- fingerprint TEXT unique not null
- public_key TEXT not null
- encrypted_private_key BYTEA null  // 可選；若上傳私鑰則加密存放
- created_by UUID not null references users(id)
- created_at timestamptz not null default now()

刪除策略
- 若有 hosts 參照，應用程式層先阻擋並回 409；DB 側可使用 on delete restrict（預設 no action）。

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `ssh_keys` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `name` VARCHAR(255) NOT NULL COMMENT '金鑰名稱（唯一）',
  `fingerprint` VARCHAR(255) NOT NULL COMMENT '金鑰指紋（唯一）',
  `public_key` TEXT NOT NULL COMMENT 'SSH 公鑰內容（OpenSSH 格式）',
  `encrypted_private_key` BLOB NULL COMMENT '加密後私鑰（可選）',
  `created_by` CHAR(36) NOT NULL COMMENT '建立者 users.id',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_ssh_keys_name` (`name`),
  UNIQUE KEY `uq_ssh_keys_fingerprint` (`fingerprint`),
  KEY `idx_ssh_keys_created_by` (`created_by`),
  CONSTRAINT `fk_ssh_keys_created_by` FOREIGN KEY (`created_by`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='SSH 金鑰';
```

### 3) hosts
- 目的：Inventory 主機。

欄位
- id UUID PK
- name TEXT not null unique
- hostname TEXT not null unique  // IP 或 DNS
- port INT not null default 22
- username TEXT not null
- ssh_key_id UUID null references ssh_keys(id)
- vars JSONB not null default '{}'::jsonb  // 主機層級變數
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()

索引
- idx_hosts_hostname (hostname)

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `hosts` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `name` VARCHAR(255) NOT NULL COMMENT '平台內顯示名稱（唯一）',
  `hostname` VARCHAR(255) NOT NULL COMMENT '主機位址（IP 或 DNS，唯一）',
  `port` INT NOT NULL DEFAULT 22 COMMENT 'SSH 連線埠，預設 22',
  `username` VARCHAR(255) NOT NULL COMMENT 'SSH 使用者名稱',
  `ssh_key_id` CHAR(36) NULL COMMENT '引用 ssh_keys.id（可為空）',
  `vars` JSON NOT NULL COMMENT '主機層級變數(JSON)，建議預設空物件',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  `updated_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '更新時間(UTC)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_hosts_name` (`name`),
  UNIQUE KEY `uq_hosts_hostname` (`hostname`),
  KEY `idx_hosts_ssh_key_id` (`ssh_key_id`),
  CONSTRAINT `fk_hosts_ssh_key` FOREIGN KEY (`ssh_key_id`) REFERENCES `ssh_keys`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Inventory 主機';
CREATE INDEX `idx_hosts_hostname` ON `hosts`(`hostname`);
```

### 4) groups
- 目的：Inventory 群組。

欄位
- id UUID PK
- name TEXT not null unique
- description TEXT
- vars JSONB not null default '{}'::jsonb  // 群組層級變數
- created_by UUID not null references users(id)
- created_at timestamptz not null default now()

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `groups` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `name` VARCHAR(255) NOT NULL COMMENT '群組名稱（唯一）',
  `description` TEXT NULL COMMENT '說明',
  `vars` JSON NOT NULL COMMENT '群組層級變數(JSON)，建議預設空物件',
  `created_by` CHAR(36) NOT NULL COMMENT '建立者 users.id',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_groups_name` (`name`),
  KEY `idx_groups_created_by` (`created_by`),
  CONSTRAINT `fk_groups_created_by` FOREIGN KEY (`created_by`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Inventory 群組';
```

### 5) host_group_members（多對多關聯）
- 目的：維護群組成員（host 列表）。

欄位
- group_id UUID not null references groups(id) on delete cascade
- host_id UUID not null references hosts(id) on delete cascade

鍵與索引
- primary key (group_id, host_id)
- index (host_id)

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `host_group_members` (
  `group_id` CHAR(36) NOT NULL COMMENT '群組 ID：groups.id',
  `host_id` CHAR(36) NOT NULL COMMENT '主機 ID：hosts.id',
  PRIMARY KEY (`group_id`,`host_id`),
  KEY `idx_hgm_host` (`host_id`),
  CONSTRAINT `fk_hgm_group` FOREIGN KEY (`group_id`) REFERENCES `groups`(`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_hgm_host` FOREIGN KEY (`host_id`) REFERENCES `hosts`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群組成員（多對多）';
```

### 6) playbooks
- 目的：Playbook 定義（結構化）。

欄位
- id UUID PK
- name TEXT not null unique
- description TEXT
- content_struct JSONB not null  // 與 API 規格一致
- raw_yaml TEXT null             // 只讀導出用途（可無）
- created_by UUID not null references users(id)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `playbooks` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `name` VARCHAR(255) NOT NULL COMMENT 'Playbook 名稱（唯一）',
  `description` TEXT NULL COMMENT '說明',
  `content_struct` JSON NOT NULL COMMENT '結構化 JSON 的 Playbook 內容（vars/tasks）',
  `raw_yaml` LONGTEXT NULL COMMENT '只讀 YAML 導出（可選）',
  `created_by` CHAR(36) NOT NULL COMMENT '建立者 users.id',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  `updated_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6) COMMENT '更新時間(UTC)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_playbooks_name` (`name`),
  KEY `idx_playbooks_created_by` (`created_by`),
  CONSTRAINT `fk_playbooks_created_by` FOREIGN KEY (`created_by`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Playbook 定義';
```

### 7) deploy_jobs
- 目的：部署工作（背景執行）。

欄位
- id UUID PK
- playbook_id UUID not null references playbooks(id)
- initiated_by UUID not null references users(id)
- status TEXT not null check (status in ('PENDING','RUNNING','SUCCESS','FAILED','CANCEL_REQUESTED','CANCELED'))
- run_mode TEXT null check (run_mode in ('parallel','serial'))
- extra_vars JSONB null
- requested_at timestamptz not null default now()
- started_at timestamptz null
- finished_at timestamptz null

索引
- idx_jobs_status (status)
- idx_jobs_initiated_by (initiated_by)
- idx_jobs_playbook (playbook_id)

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `deploy_jobs` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `playbook_id` CHAR(36) NOT NULL COMMENT '引用 playbooks.id',
  `initiated_by` CHAR(36) NOT NULL COMMENT '發起者 users.id',
  `status` ENUM('PENDING','RUNNING','SUCCESS','FAILED','CANCEL_REQUESTED','CANCELED') NOT NULL COMMENT '工作狀態',
  `run_mode` ENUM('parallel','serial') NULL COMMENT '執行模式：parallel/serial',
  `extra_vars` JSON NULL COMMENT 'Job 層級參數(JSON)',
  `requested_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '請求時間(UTC)',
  `started_at` DATETIME(6) NULL COMMENT '開始時間(UTC)',
  `finished_at` DATETIME(6) NULL COMMENT '完成時間(UTC)',
  PRIMARY KEY (`id`),
  KEY `idx_jobs_status` (`status`),
  KEY `idx_jobs_initiated_by` (`initiated_by`),
  KEY `idx_jobs_playbook` (`playbook_id`),
  CONSTRAINT `fk_jobs_playbook` FOREIGN KEY (`playbook_id`) REFERENCES `playbooks`(`id`),
  CONSTRAINT `fk_jobs_initiated_by` FOREIGN KEY (`initiated_by`) REFERENCES `users`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署工作';
```

### 8) deploy_job_targets（每台目標主機結果）
- 目的：儲存每個 job 對各 host 的執行結果。

欄位
- id UUID PK
- job_id UUID not null references deploy_jobs(id) on delete cascade
- host_id UUID not null references hosts(id)
- host_name TEXT not null  // 快照，避免改名影響歷史
- status TEXT not null check (status in ('PENDING','RUNNING','SUCCESS','FAILED','CANCELED'))
- changed BOOLEAN not null default false
- elapsed_ms INT null
- started_at timestamptz null
- finished_at timestamptz null
- error TEXT null

索引
- idx_job_targets_job (job_id)
- idx_job_targets_host (host_id)

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `deploy_job_targets` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `job_id` CHAR(36) NOT NULL COMMENT '引用 deploy_jobs.id',
  `host_id` CHAR(36) NOT NULL COMMENT '引用 hosts.id',
  `host_name` VARCHAR(255) NOT NULL COMMENT '主機名稱快照，避免改名影響歷史',
  `status` ENUM('PENDING','RUNNING','SUCCESS','FAILED','CANCELED') NOT NULL COMMENT '目標主機執行狀態',
  `changed` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否有變更（Ansible changed）',
  `elapsed_ms` INT NULL COMMENT '耗時（毫秒）',
  `started_at` DATETIME(6) NULL COMMENT '開始時間(UTC)',
  `finished_at` DATETIME(6) NULL COMMENT '完成時間(UTC)',
  `error` TEXT NULL COMMENT '錯誤訊息（若失敗）',
  PRIMARY KEY (`id`),
  KEY `idx_job_targets_job` (`job_id`),
  KEY `idx_job_targets_host` (`host_id`),
  CONSTRAINT `fk_job_targets_job` FOREIGN KEY (`job_id`) REFERENCES `deploy_jobs`(`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_job_targets_host` FOREIGN KEY (`host_id`) REFERENCES `hosts`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署工作之目標主機結果';
```

### 9) deploy_job_logs（行為單位的日誌）
- 目的：完整日誌保存；便於以時間序或插入序輸出；可對應 WebSocket 流。

欄位
- id bigserial PK  // 兼具遞增行號
- job_id UUID not null references deploy_jobs(id) on delete cascade
- ts timestamptz not null default now()
- host TEXT null  // 哪台主機產生（若有）
- line TEXT not null

索引
- idx_job_logs_job (job_id, id)  // 便於以 id 游標翻頁

參考 DDL（MySQL 8.0+）
```sql
CREATE TABLE `deploy_job_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '流水號主鍵（行號）',
  `job_id` CHAR(36) NOT NULL COMMENT '引用 deploy_jobs.id',
  `ts` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '記錄時間(UTC)',
  `host` VARCHAR(255) NULL COMMENT '日誌來源主機（如有）',
  `line` LONGTEXT NOT NULL COMMENT '日誌內容一行',
  PRIMARY KEY (`id`),
  KEY `idx_job_logs_job` (`job_id`,`id`),
  CONSTRAINT `fk_job_logs_job` FOREIGN KEY (`job_id`) REFERENCES `deploy_jobs`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署工作日誌（行為單位）';
```

---

## 索引與約束摘要（MySQL）

- 唯一鍵：users.username、ssh_keys.name、ssh_keys.fingerprint、hosts.name、hosts.hostname、groups.name、playbooks.name。
- 外鍵：
  - hosts.ssh_key_id → ssh_keys.id（刪除前需檢查，避免 409）
  - host_group_members.{group_id,host_id} → groups.id、hosts.id（on delete cascade）
  - playbooks.created_by → users.id
  - deploy_jobs.playbook_id → playbooks.id
  - deploy_jobs.initiated_by → users.id
  - deploy_job_targets.job_id → deploy_jobs.id（on delete cascade）
  - deploy_job_logs.job_id → deploy_jobs.id（on delete cascade）
- 常用索引：
  - hosts(hostname)、deploy_jobs(status)、deploy_jobs(initiated_by)、deploy_jobs(playbook_id)
  - deploy_job_targets(job_id)、deploy_job_targets(host_id)
  - deploy_job_logs(job_id,id)

刪除策略建議
- ssh_keys：若被 hosts 參照應回 409（應用程式檢查）；DB 預設 no action。
- groups/hosts 刪除：關聯表 host_group_members 採 on delete cascade 自動清理對應關聯。
- deploy_jobs 刪除：其 targets 與 logs 採 on delete cascade 一併清除。

---

## 與 API 契約的對齊點

- Playbooks：content_struct 必填；raw_yaml 為只讀可選欄位；部署禁止 inline 上傳。
- Inventory：host.vars 與 group.vars 均為 JSON；群組成員以中介表維護；API 的 members 增刪對應於 host_group_members 寫入/刪除。
- Deployment Jobs：
  - deploy_jobs.status 與 deploy_job_targets.status 覆蓋 PENDING/RUNNING/SUCCESS/FAILED/CANCEL_REQUESTED/CANCELED；
  - run_mode 支援 parallel/serial；
  - extra_vars 為 JSON；
  - logs 以 deploy_job_logs 行為單位保存，支援依 id 連續擷取（對應 WebSocket 與 Audit API）。
- SSH Keys：刪除時若被 hosts 參照應回 409，與 API 規格一致。

---

## 非 MVP／未來擴充（參考）

若未來啟用 AI 助理，可新增下列表（不影響現行核心設計）：

### ai_tasks（選擇性）
- 欄位（示意）
  - id CHAR(36) PK
  - user_id CHAR(36) not null references users(id)
  - raw_prompt LONGTEXT not null
  - generated_playbook_id CHAR(36) null references playbooks(id)
  - created_at DATETIME(6) not null default current_timestamp(6)
  - result JSON null  // 將解析與建議紀錄

---

## 備註

- 欄位命名與型別可依團隊慣例微調；但請保持與 API 回應/請求欄位名對齊。
- 建議以資料遷移工具（如 Alembic/Flyway）維護版本；初始即建立必要索引與約束。
- 本文件已提供 MySQL 8.0+ 版 DDL；若採 MariaDB，請依版本調整 JSON 與預設值語法。

參考 DDL（ai_tasks，MySQL 8.0+）
```sql
CREATE TABLE `ai_tasks` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `user_id` CHAR(36) NOT NULL COMMENT '使用者 users.id',
  `raw_prompt` LONGTEXT NOT NULL COMMENT '原始提示內容',
  `generated_playbook_id` CHAR(36) NULL COMMENT 'AI 產生之 playbooks.id（可為空）',
  `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '建立時間(UTC)',
  `result` JSON NULL COMMENT 'AI 結果物(JSON)',
  PRIMARY KEY (`id`),
  KEY `idx_ai_tasks_user` (`user_id`),
  CONSTRAINT `fk_ai_tasks_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),
  CONSTRAINT `fk_ai_tasks_playbook` FOREIGN KEY (`generated_playbook_id`) REFERENCES `playbooks`(`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI 任務（選擇性）';
```