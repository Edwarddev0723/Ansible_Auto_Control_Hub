# Ansible 部署系統 — 專案說明書（簡單版，僅部署程式碼）

本文件描述一個「最小可行」的 Ansible 部署系統，唯一目標是：將 Git repository 的程式碼部署到多台 Linux 主機的指定路徑。省略使用者、群組、Playbook 管理、WebSocket 等複雜功能，以最短時間完成可交付的期末專案。

---

## 1. 核心功能

- 由前端送出部署請求：包含 git_repo、git_branch、dest_path，以及多台目標主機（host、port、username、認證）。
- 後端動態產生最小 Playbook（僅使用 `ansible.builtin.git` 模組）與暫存 inventory，執行 ansible。
- 可查詢 Job 列表、單筆詳細，以及下載完整日誌（text 或 json 行陣列）。

---

## 2. 使用流程（最簡版）

1) 前端填單：
- Git repo：`git@github.com:org/repo.git` 或 `https://github.com/org/repo.git`
- Branch：`main`（文字）
- Dest 路徑：`/var/www/app`（絕對路徑）
- 目標主機：
  - host、port(預設 22)、username
  - 認證：私鑰或密碼（二選一）

2) 呼叫 API：`POST /api/v1/jobs`（見 API 設計(簡單版)）

3) 後端執行：
- 生成暫存 inventory（含各主機與連線參數）
- 生成最小 Playbook（如下）
- 執行 ansible，過程中寫入 logs 與 targets 狀態

4) 前端查詢：
- `GET /api/v1/jobs` 列表
- `GET /api/v1/jobs/{job_id}` 詳細（含每台主機結果）
- `GET /api/v1/jobs/{job_id}/logs?format=text|json` 日誌

---

## 3. 最小 Playbook（執行時動態產生）

語意：在 all 主機上，將指定 git_repo 的指定 branch 取得到 dest_path，若路徑不存在則由 git 模組建立，等同於「初次 clone 或之後的 pull 最新」。

對應 YAML（示意）：
```yaml
---
- hosts: all
  gather_facts: false
  tasks:
    - name: Deploy code via git
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        version: "{{ git_branch }}"
        dest: "{{ dest_path }}"
        update: true
```

變數來源：`git_repo`、`git_branch`、`dest_path` 由 API 請求提供；後端合成為 extra_vars。

---

## 4. 架構（最小）

- 後端：FastAPI（或 Flask）+ subprocess/ansible-runner 執行 Ansible
- DB：MySQL 8.0+（三表：deploy_jobs、deploy_job_targets、deploy_job_logs）
- 前端：任意（表單頁 + 列表頁 + 詳細頁），無需 WebSocket

---

## 5. 安裝與執行（參考）

環境需求：
- Python 3.10+
- Ansible 2.15+（含 ansible-core）
- MySQL 8.0+

步驟摘要：
- 安裝後端依賴（FastAPI + uvicorn + SQL 驅動 + pydantic + sqlalchemy 等）
- 安裝 Ansible
- 建立資料表（參見《資料庫設計(簡單版)》）
- 啟動 API 伺服器

---

## 6. 限制與假設

- 僅支援 Linux 目標主機；需具備 git、必要套件與正確權限。
- 認證資訊不入庫，僅在執行期間使用；完成後即釋放暫存。
- 沒有使用者/權限管理、沒有 Inventory/群組管理、沒有 Playbook 管理。
- 若需擴充（例如：固定主機清單、SSH Key 管理、WebSocket 即時日誌），請改用「(複雜版)」方案。

---

## 7. 專案檔對照

- 《API 設計(簡單版).md》：最小端點（jobs + logs）
- 《資料庫設計(簡單版).md》：三表 DDL（MySQL 8.0+）
- 《專案說明書(簡單版).md》：本文件（架構/流程/限制）

進階需求請參考：
- 《API 設計(複雜版).md》
- 《資料庫設計(複雜版).md》
- 《專案說明書(複雜版).md》
