# 資料庫設計（簡單版）— 最小可行：Jobs / Targets / Logs（MySQL 8.0+）

目標：只為「將 Git 程式碼部署到多台主機」這個單一功能設計最少資料表，方便後端實作背景工作與查詢日誌。

關鍵裁剪：
- 不做 users、groups、playbooks、ssh_keys 等表。
- 建立 job 時即帶入目標主機資訊（inline），資料庫僅保存結果（不保存敏感認證資料）。
- 僅三張表：deploy_jobs、deploy_job_targets、deploy_job_logs。

設計原則（MySQL 8.0+）
- 主鍵 UUID 以 CHAR(36)。
- 時間欄位使用 DATETIME(6)（UTC）。
- 狀態以 ENUM 簡化（PENDING/RUNNING/SUCCESS/FAILED）。

---

## 1) deploy_jobs — 部署工作

用途：記錄一次部署請求的共用參數（git_repo、git_branch、dest_path、run_mode）與整體狀態；不保存任何私鑰或密碼。

參考 DDL
```sql
CREATE TABLE `deploy_jobs` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `git_repo` VARCHAR(512) NOT NULL COMMENT 'Git repository URL (SSH/HTTPS)',
  `git_branch` VARCHAR(128) NOT NULL COMMENT '要部署的分支/版本',
  `dest_path` VARCHAR(512) NOT NULL COMMENT '目標主機上的部署路徑 (絕對路徑)',
  `run_mode` ENUM('parallel','serial') NOT NULL DEFAULT 'parallel' COMMENT '執行模式',
  `status` ENUM('PENDING','RUNNING','SUCCESS','FAILED') NOT NULL COMMENT '工作狀態',
  `requested_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '請求時間(UTC)',
  `started_at` DATETIME(6) NULL COMMENT '開始時間(UTC)',
  `finished_at` DATETIME(6) NULL COMMENT '完成時間(UTC)',
  PRIMARY KEY (`id`),
  KEY `idx_jobs_status` (`status`),
  KEY `idx_jobs_requested_at` (`requested_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署工作（簡易版）';
```

---

## 2) deploy_job_targets — 每台主機的執行結果

用途：保存此 job 在每個 target host 上的執行狀態與耗時、是否 changed，以及錯誤訊息（如失敗）。不保存認證資料。

參考 DDL
```sql
CREATE TABLE `deploy_job_targets` (
  `id` CHAR(36) NOT NULL COMMENT 'UUID 主鍵',
  `job_id` CHAR(36) NOT NULL COMMENT '對應 deploy_jobs.id',
  `host` VARCHAR(255) NOT NULL COMMENT '目標主機 IP 或 DNS',
  `port` INT NOT NULL DEFAULT 22 COMMENT 'SSH 連線埠',
  `username` VARCHAR(255) NOT NULL COMMENT 'SSH 使用者名稱',
  `status` ENUM('PENDING','RUNNING','SUCCESS','FAILED') NOT NULL COMMENT '主機執行狀態',
  `changed` TINYINT(1) NULL COMMENT '是否有變更 (Ansible changed)',
  `elapsed_ms` INT NULL COMMENT '耗時（毫秒）',
  `error` TEXT NULL COMMENT '錯誤訊息（若失敗）',
  `started_at` DATETIME(6) NULL COMMENT '開始時間(UTC)',
  `finished_at` DATETIME(6) NULL COMMENT '完成時間(UTC)',
  PRIMARY KEY (`id`),
  KEY `idx_targets_job` (`job_id`),
  CONSTRAINT `fk_targets_job` FOREIGN KEY (`job_id`) REFERENCES `deploy_jobs`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='單一工作在每台目標主機的結果';
```

---

## 3) deploy_job_logs — 日誌（以行為單位）

用途：儲存執行過程的輸出行，以便 UI 輪詢載入（支援依 id 增量擷取）。

參考 DDL
```sql
CREATE TABLE `deploy_job_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '流水號主鍵（行號）',
  `job_id` CHAR(36) NOT NULL COMMENT '對應 deploy_jobs.id',
  `ts` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) COMMENT '記錄時間(UTC)',
  `host` VARCHAR(255) NULL COMMENT '輸出來源主機（若有）',
  `line` LONGTEXT NOT NULL COMMENT '日誌文字內容一行',
  PRIMARY KEY (`id`),
  KEY `idx_logs_job` (`job_id`,`id`),
  CONSTRAINT `fk_logs_job` FOREIGN KEY (`job_id`) REFERENCES `deploy_jobs`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部署日誌（行為單位）';
```

---

## 對應 API 與最小流程

- 建立 Job：POST /api/v1/jobs
  - 寫入 deploy_jobs（PENDING）
  - 為每個 target 建立 deploy_job_targets（PENDING）
- 執行器（背景）：
  - 轉出暫存 inventory 與最小 Playbook（git 模組），執行 ansible
  - 流程中持續寫入 deploy_job_logs
  - 每台主機完成後更新 deploy_job_targets.status/changed/elapsed_ms
  - 所有主機完成後更新 deploy_jobs.status 與 finished_at
- 查詢列表/詳細/日誌：
  - GET /api/v1/jobs；GET /api/v1/jobs/{job_id}；GET /api/v1/jobs/{job_id}/logs

---

## 備註（安全與簡化考量）
- 認證資料（私鑰/密碼）不入庫，僅在執行期間存在記憶體/暫存檔（執行結束即清除）。
- 如需長期重複使用同一批主機，才需要增加 hosts/ssh_keys 表與管理介面；MVP 暫不需要。
- 如需排序與查詢效能，可視需求為 git_repo、requested_at 等欄位補充索引。
